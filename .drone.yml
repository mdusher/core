---
kind: pipeline
type: docker
name: install-dependencies-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: cache-rebuild
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - .cache
    rebuild: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    event:
    - push
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: cache-flush
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    flush: true
    flush_age: 14
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    event:
    - push
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: coding-standard-php7.3

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: php-style
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- install-dependencies-php7.1

---
kind: pipeline
type: docker
name: phpstan-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: php-phpstan
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phpstan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- install-dependencies-php7.1

---
kind: pipeline
type: docker
name: phan-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: phan
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- install-dependencies-php7.1

---
kind: pipeline
type: docker
name: phan-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: phan
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- install-dependencies-php7.1

---
kind: pipeline
type: docker
name: phan-php7.3

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: phan
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- install-dependencies-php7.1

---
kind: pipeline
type: docker
name: test-javascript

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: test-js
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-js

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - javascript
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: litmus-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: tech-preview
  pull: always
  image: owncloudci/php:7.1
  commands:
  - php occ config:system:set dav.enable.tech_preview --value=true --type boolean

- name: setup-storage
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir -p /drone/src/work/local_storage
  - php occ app:enable files_external
  - php occ config:system:set files_external_allow_create_new_local --value=true
  - php occ config:app:set core enable_external_storage --value=yes
  - php occ files_external:create local_storage local null::null -c datadir=/drone/src/work/local_storage
  - php occ user:add --password-from-env user1
  environment:
    OC_PASS: 123456

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: create-share
  pull: always
  image: owncloudci/php:7.1
  commands:
  - curl -k -s -u user1:123456 -X MKCOL "https://server/remote.php/webdav/new_folder"
  - curl -k -s -u user1:123456 "https://server/ocs/v2.php/apps/files_sharing/api/v1/shares" --data "path=/new_folder&shareType=0&permissions=15&name=new_folder&shareWith=admin"
  - echo -n "PUBLIC_TOKEN=" > .env
  - curl -k -s -u user1:123456 "https://server/ocs/v2.php/apps/files_sharing/api/v1/shares" --data "path=/new_folder&shareType=3&permissions=15&name=new_folder" | grep token | cut -d">" -f2 | cut -d"<" -f1 >> .env

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: old-endpoint
  pull: always
  image: owncloud/litmus:latest
  commands:
  - source .env
  - export LITMUS_URL="https://server/remote.php/webdav"
  - /usr/local/bin/litmus-wrapper
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_USERNAME: admin
    TESTS: basic copymove props locks http

- name: new-endpoint
  pull: always
  image: owncloud/litmus:latest
  commands:
  - source .env
  - export LITMUS_URL="https://server/remote.php/dav/files/admin"
  - /usr/local/bin/litmus-wrapper
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_USERNAME: admin
    TESTS: basic copymove props locks http

- name: new-mount
  pull: always
  image: owncloud/litmus:latest
  commands:
  - source .env
  - export LITMUS_URL="https://server/remote.php/dav/files/admin/local_storage/"
  - /usr/local/bin/litmus-wrapper
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_USERNAME: admin
    TESTS: basic copymove props locks http

- name: old-mount
  pull: always
  image: owncloud/litmus:latest
  commands:
  - source .env
  - export LITMUS_URL="https://server/remote.php/webdav/local_storage/"
  - /usr/local/bin/litmus-wrapper
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_USERNAME: admin
    TESTS: basic copymove props locks http

- name: new-shared
  pull: always
  image: owncloud/litmus:latest
  commands:
  - source .env
  - export LITMUS_URL="https://server/remote.php/dav/files/admin/new_folder/"
  - /usr/local/bin/litmus-wrapper
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_USERNAME: admin
    TESTS: basic copymove props locks http

- name: old-shared
  pull: always
  image: owncloud/litmus:latest
  commands:
  - source .env
  - export LITMUS_URL="https://server/remote.php/webdav/new_folder/"
  - /usr/local/bin/litmus-wrapper
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_USERNAME: admin
    TESTS: basic copymove props locks http

- name: public-share
  pull: always
  image: owncloud/litmus:latest
  commands:
  - source .env
  - export LITMUS_URL='https://server/remote.php/dav/public-files/'$PUBLIC_TOKEN
  - /usr/local/bin/litmus-wrapper
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_USERNAME: admin
    TESTS: basic copymove http

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: caldav-new-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: dav-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: dav-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav/script.sh

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: caldav-old-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: dav-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav-old-endpoint/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: dav-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav-old-endpoint/script.sh

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: carddav-new-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: dav-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: dav-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav/script.sh

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: carddav-old-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: dav-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav-old-endpoint/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: dav-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav-old-endpoint/script.sh

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: sqlite

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-mariadb10.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: mariadb

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-mariadb10.3

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: mariadb

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: mariadb
  pull: always
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-mysql5.5

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mysql

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: mysql

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-mysql5.7

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mysql

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: mysql

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: mysql
  pull: always
  image: mysql:5.7
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-postgres9.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: postgres

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: postgres

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-oracle

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: oracle

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: oracle

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: oracle
  pull: always
  image: deepdiver/docker-oracle-xe-11g:latest
  environment:
    ORACLE_DB: XE
    ORACLE_DISABLE_ASYNCH_IO: true
    ORACLE_PASSWORD: oracle
    ORACLE_USER: system

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.0-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.0
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.0
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.0
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: false
    DB_TYPE: sqlite

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.0-mariadb10.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.0
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.0
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.0
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: false
    DB_TYPE: mariadb

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.2-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: false
    DB_TYPE: sqlite

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.2-mariadb10.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: false
    DB_TYPE: mariadb

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.3-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.3
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: false
    DB_TYPE: sqlite

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.3-mariadb10.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.3
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: false
    DB_TYPE: mariadb

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-sqlite-samba

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -l /var/cache
  - mkdir /var/cache/samba
  - ls -l /var/cache
  - ls -l /var/cache/samba
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: sqlite
    FILES_EXTERNAL_TYPE: samba

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: samba
  pull: always
  image: owncloudci/samba:latest
  command:
  - -u
  - test;test
  - -s
  - public;/tmp;yes;no;no;test;none;test
  - -S

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-sqlite-windows

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -l /var/cache
  - mkdir /var/cache/samba
  - ls -l /var/cache
  - ls -l /var/cache/samba
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: sqlite
    FILES_EXTERNAL_TYPE: windows

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-sqlite-webdav

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: sqlite
    FILES_EXTERNAL_TYPE: webdav

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: webdav
  pull: always
  image: owncloudci/php:latest
  command:
  - /usr/local/bin/apachectl
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: webdav

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-sqlite-sftp

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: sqlite
    FILES_EXTERNAL_TYPE: sftp

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: sftp
  pull: always
  image: atmoz/sftp
  environment:
    SFTP_USERS: test:12345:1001::upload

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-php7.1-sqlite-scality

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/files_primary_s3.git /drone/src/apps/files_primary_s3
  - cd /drone/src/apps/files_primary_s3
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:l

- name: setup-scality
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 60 scality:8000
  - cp /drone/src/apps/files_primary_s3/tests/drone/scality.config.php /drone/src/config
  - php occ s3:create-bucket owncloud --accept-warning

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - su-exec www-data bash tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    DB_TYPE: sqlite
    PRIMARY_OBJECTSTORE: files_primary_s3

- name: coverage-upload
  pull: always
  image: plugins/codecov:2
  settings:
    files:
    - "*.xml"
    flags:
    - phpunit
    paths:
    - tests/output/coverage
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server:latest
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAuth-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiAuth
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAuthOcs-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiAuthOcs
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiCapabilities-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiCapabilities
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiComments-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiComments
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiFavorites-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiFavorites
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiMain-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiMain
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiProvisioning-v1-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiProvisioning-v1
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiProvisioning-v2-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiProvisioning-v2
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiProvisioningGroups-v1-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiProvisioningGroups-v1
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiProvisioningGroups-v2-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiProvisioningGroups-v2
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiSharees-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiSharees
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiShareManagement-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiShareManagement
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiShareManagementBasic-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiShareManagementBasic
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiShareOperations-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiShareOperations
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiShareReshare-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiShareReshare
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiShareUpdate-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiShareUpdate
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiTags-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiTags
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiTrashbin-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiTrashbin
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiVersions-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiVersions
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiWebdavLocks-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiWebdavLocks
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiWebdavLocks2-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiWebdavLocks2
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiWebdavMove-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiWebdavMove
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiWebdavOperations-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiWebdavOperations
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiWebdavProperties-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiWebdavProperties
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiWebdavUpload-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiWebdavUpload
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiSharingNotifications-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - git clone https://github.com/owncloud/notifications.git /drone/src/apps/notifications
  - cd /drone/src/apps/notifications
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e notifications
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiSharingNotifications
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiFederation-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /drone/federated
    version: daily-master-qa

- name: configure-federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /drone/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - echo "export TEST_SERVER_FED_URL=https://federated" > /drone/saved-settings.sh
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/federated/data/owncloud.log

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src
  - chown -R www-data /drone/federated

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiFederation
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

- name: federated
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/federated.crt
    APACHE_SSL_CERT_CN: federated
    APACHE_SSL_KEY: /drone/federated.key
    APACHE_WEBROOT: /drone/federated

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiFederation-10.2.1-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /drone/federated
    version: 10.2.1

- name: configure-federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /drone/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - echo "export TEST_SERVER_FED_URL=https://federated" > /drone/saved-settings.sh
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/federated/data/owncloud.log

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src
  - chown -R www-data /drone/federated

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiFederation
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

- name: federated
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/federated.crt
    APACHE_SSL_CERT_CN: federated
    APACHE_SSL_KEY: /drone/federated.key
    APACHE_WEBROOT: /drone/federated

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: cliBackground-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliBackground
    MAILHOG_HOST: email
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: cliMain-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliMain
    MAILHOG_HOST: email
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: cliProvisioning-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliProvisioning
    MAILHOG_HOST: email
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: cliTrashbin-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliTrashbin
    MAILHOG_HOST: email
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: cliAppManagement-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - su-exec www-data make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliAppManagement
    TESTING_REMOTE_SYSTEM: false
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIAddUsers-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIAddUsers
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIAdminSettings-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIAdminSettings
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIComments-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIComments
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUICreateDelete-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUICreateDelete
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIFavorites-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIFavorites
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIFiles-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIFiles
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUILogin-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUILogin
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIManageQuota-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIManageQuota
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIManageUsersGrps-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIManageUsersGroups
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIMoveFilesFolder-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIMoveFilesFolders
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIPersonalSetting-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIPersonalSettings
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIRenameFiles-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIRenameFiles
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIRenameFolders-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIRenameFolders
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIRestrictSharing-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIRestrictSharing
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISettingsMenu-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISettingsMenu
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingAcceptSh-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingAcceptShares
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingAutocomp-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingAutocompletion
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingIntGroup-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingInternalGroups
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingIntUsers-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingInternalUsers
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingPublic-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingPublic
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUITags-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUITags
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUITrashbin-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUITrashbin
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIUpload-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIUpload
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIWebdavLockProt-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIWebdavLockProtection
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIWebdavLocks-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIWebdavLocks
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingNotify-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - git clone https://github.com/owncloud/notifications.git /drone/src/apps/notifications
  - cd /drone/src/apps/notifications
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e notifications
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingNotifications
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingExt-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /drone/federated
    version: daily-master-qa

- name: configure-federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /drone/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - echo "export TEST_SERVER_FED_URL=https://federated" > /drone/saved-settings.sh
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/federated/data/owncloud.log

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src
  - chown -R www-data /drone/federated

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingExternal
    BROWSER: chrome
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

- name: federated
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/federated.crt
    APACHE_SSL_CERT_CN: federated
    APACHE_SSL_KEY: /drone/federated.key
    APACHE_WEBROOT: /drone/federated

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUISharingExt-10.2.1-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /drone/federated
    version: 10.2.1

- name: configure-federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /drone/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - echo "export TEST_SERVER_FED_URL=https://federated" > /drone/saved-settings.sh
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/federated/data/owncloud.log

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src
  - chown -R www-data /drone/federated

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUISharingExternal
    BROWSER: chrome
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: https://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src

- name: federated
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/federated.crt
    APACHE_SSL_CERT_CN: federated
    APACHE_SSL_KEY: /drone/federated.key
    APACHE_WEBROOT: /drone/federated

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIFfSmoke-3-1-firefox-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    BROWSER: firefox
    DIVIDE_INTO_NUM_PARTS: 3
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 1
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-firefox-debug:3.8.1
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING
    SE_OPTS: -enablePassThrough false

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIFfSmoke-3-2-firefox-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    BROWSER: firefox
    DIVIDE_INTO_NUM_PARTS: 3
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 2
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-firefox-debug:3.8.1
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING
    SE_OPTS: -enablePassThrough false

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIFfSmoke-3-3-firefox-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    BROWSER: firefox
    DIVIDE_INTO_NUM_PARTS: 3
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 3
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-firefox-debug:3.8.1
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING
    SE_OPTS: -enablePassThrough false

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIProxySmoke-3-1-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 3 --value=proxy
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 3
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 1
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://proxy

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: proxy
  pull: always
  image: pottava/proxy
  environment:
    PROXY_URL: http://server

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIProxySmoke-3-2-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 3 --value=proxy
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 3
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 2
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://proxy

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: proxy
  pull: always
  image: pottava/proxy
  environment:
    PROXY_URL: http://server

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIProxySmoke-3-3-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 3 --value=proxy
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 3
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 3
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://proxy

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: proxy
  pull: always
  image: pottava/proxy
  environment:
    PROXY_URL: http://server

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiProxySmoke-3-1-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 3 --value=proxy
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    DIVIDE_INTO_NUM_PARTS: 3
    RUN_PART: 1
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://proxy

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: proxy
  pull: always
  image: pottava/proxy
  environment:
    PROXY_URL: http://server

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiProxySmoke-3-2-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 3 --value=proxy
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    DIVIDE_INTO_NUM_PARTS: 3
    RUN_PART: 2
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://proxy

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: proxy
  pull: always
  image: pottava/proxy
  environment:
    PROXY_URL: http://server

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiProxySmoke-3-3-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ config:system:set trusted_domains 3 --value=proxy
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-extra-apps
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git /drone/src/apps/testing
  - cd /drone/src/apps/testing
  - composer install
  - cd /drone/src
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /drone/src

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /drone/src/data/owncloud.log

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: "@smokeTest&&~@notifications-app-required"
    DIVIDE_INTO_NUM_PARTS: 3
    RUN_PART: 3
    TESTING_REMOTE_SYSTEM: true
    TEST_SERVER_URL: http://proxy

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: proxy
  pull: always
  image: pottava/proxy
  environment:
    PROXY_URL: http://server

- name: server
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.3
- phpstan-php7.1
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: server
    webhook:
      from_secret: public_rocketchat

trigger:
  ref:
  - refs/tags/**
  - refs/heads/master
  status:
  - success
  - failure

depends_on:
- test-javascript
- litmus-php7.1
- caldav-new-php7.1
- caldav-old-php7.1
- carddav-new-php7.1
- carddav-old-php7.1
- phpunit-php7.1-sqlite
- phpunit-php7.1-mariadb10.2
- phpunit-php7.1-mariadb10.3
- phpunit-php7.1-mysql5.5
- phpunit-php7.1-mysql5.7
- phpunit-php7.1-postgres9.4
- phpunit-php7.1-oracle
- phpunit-php7.0-sqlite
- phpunit-php7.0-mariadb10.2
- phpunit-php7.2-sqlite
- phpunit-php7.2-mariadb10.2
- phpunit-php7.3-sqlite
- phpunit-php7.3-mariadb10.2
- phpunit-php7.1-sqlite-samba
- phpunit-php7.1-sqlite-windows
- phpunit-php7.1-sqlite-webdav
- phpunit-php7.1-sqlite-sftp
- phpunit-php7.1-sqlite-scality
- apiAuth-mariadb10.2-php7.1
- apiAuthOcs-mariadb10.2-php7.1
- apiCapabilities-mariadb10.2-php7.1
- apiComments-mariadb10.2-php7.1
- apiFavorites-mariadb10.2-php7.1
- apiMain-mariadb10.2-php7.1
- apiProvisioning-v1-mariadb10.2-php7.1
- apiProvisioning-v2-mariadb10.2-php7.1
- apiProvisioningGroups-v1-mariadb10.2-php7.1
- apiProvisioningGroups-v2-mariadb10.2-php7.1
- apiSharees-mariadb10.2-php7.1
- apiShareManagement-mariadb10.2-php7.1
- apiShareManagementBasic-mariadb10.2-php7.1
- apiShareOperations-mariadb10.2-php7.1
- apiShareReshare-mariadb10.2-php7.1
- apiShareUpdate-mariadb10.2-php7.1
- apiTags-mariadb10.2-php7.1
- apiTrashbin-mariadb10.2-php7.1
- apiVersions-mariadb10.2-php7.1
- apiWebdavLocks-mariadb10.2-php7.1
- apiWebdavLocks2-mariadb10.2-php7.1
- apiWebdavMove-mariadb10.2-php7.1
- apiWebdavOperations-mariadb10.2-php7.1
- apiWebdavProperties-mariadb10.2-php7.1
- apiWebdavUpload-mariadb10.2-php7.1
- apiSharingNotifications-mariadb10.2-php7.1
- apiFederation-master-mariadb10.2-php7.1
- apiFederation-10.2.1-mariadb10.2-php7.1
- cliBackground-mariadb10.2-php7.1
- cliMain-mariadb10.2-php7.1
- cliProvisioning-mariadb10.2-php7.1
- cliTrashbin-mariadb10.2-php7.1
- cliAppManagement-mariadb10.2-php7.1
- webUIAddUsers-chrome-mariadb10.2-php7.1
- webUIAdminSettings-chrome-mariadb10.2-php7.1
- webUIComments-chrome-mariadb10.2-php7.1
- webUICreateDelete-chrome-mariadb10.2-php7.1
- webUIFavorites-chrome-mariadb10.2-php7.1
- webUIFiles-chrome-mariadb10.2-php7.1
- webUILogin-chrome-mariadb10.2-php7.1
- webUIManageQuota-chrome-mariadb10.2-php7.1
- webUIManageUsersGrps-chrome-mariadb10.2-php7.1
- webUIMoveFilesFolder-chrome-mariadb10.2-php7.1
- webUIPersonalSetting-chrome-mariadb10.2-php7.1
- webUIRenameFiles-chrome-mariadb10.2-php7.1
- webUIRenameFolders-chrome-mariadb10.2-php7.1
- webUIRestrictSharing-chrome-mariadb10.2-php7.1
- webUISettingsMenu-chrome-mariadb10.2-php7.1
- webUISharingAcceptSh-chrome-mariadb10.2-php7.1
- webUISharingAutocomp-chrome-mariadb10.2-php7.1
- webUISharingIntGroup-chrome-mariadb10.2-php7.1
- webUISharingIntUsers-chrome-mariadb10.2-php7.1
- webUISharingPublic-chrome-mariadb10.2-php7.1
- webUITags-chrome-mariadb10.2-php7.1
- webUITrashbin-chrome-mariadb10.2-php7.1
- webUIUpload-chrome-mariadb10.2-php7.1
- webUIWebdavLockProt-chrome-mariadb10.2-php7.1
- webUIWebdavLocks-chrome-mariadb10.2-php7.1
- webUISharingNotify-chrome-mariadb10.2-php7.1
- webUISharingExt-master-chrome-mariadb10.2-php7.1
- webUISharingExt-10.2.1-chrome-mariadb10.2-php7.1
- webUIFfSmoke-3-1-firefox-mariadb10.2-php7.1
- webUIFfSmoke-3-2-firefox-mariadb10.2-php7.1
- webUIFfSmoke-3-3-firefox-mariadb10.2-php7.1
- webUIProxySmoke-3-1-chrome-mariadb10.2-php7.1
- webUIProxySmoke-3-2-chrome-mariadb10.2-php7.1
- webUIProxySmoke-3-3-chrome-mariadb10.2-php7.1
- apiProxySmoke-3-1-mariadb10.2-php7.1
- apiProxySmoke-3-2-mariadb10.2-php7.1
- apiProxySmoke-3-3-mariadb10.2-php7.1

...
